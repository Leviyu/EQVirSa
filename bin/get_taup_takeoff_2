#!/bin/tcsh

# ====================================================================
# This is a csh script to return the taup_time for a record
# 
# Input: EQ info
# 		station
# 		phase info
#
# Output: a file store travel time for all phases for current EQ_STA
#
#
# DATE:					Keywords:
#
# Reference:
# ===================================================================


set EQ =	$1
set sta_lat = $2
set sta_lon = $3
set PHASE = $4

set eq_lat = `check_event $EQ|grep -w EQ_LAT_ISC |awk '{print $2}' `
set eq_lon = `check_event $EQ|grep -w EQ_LON_ISC |awk '{print $2}' `
set eq_dep = `check_event $EQ|grep -w EQ_DEP_ISC |awk '{print $2}' `


# remove major flag
if(`echo $PHASE | grep m ` == "" ) then
set main_PHASE = $PHASE
else
set main_PHASE = `echo $PHASE | sed 's/.$//' `
endif

set taup_time_file = /mnt/data2/maligaro/EQVirSa/bin/CMT_prediction/.taupfile.tmp.$$
taup_time -mod prem -ph $main_PHASE -h $eq_dep -sta $sta_lat $sta_lon -evt $eq_lat $eq_lon >! $taup_time_file


# Get minor phase taup_time 
# This is done by grabing the first travel time given by taup_time that < 180
# The major phase is done by grabing the first travel time given by taup that is > 180
if($PHASE == $main_PHASE ) then
set main_result = `cat $taup_time_file |grep -w $main_PHASE | awk '$8<180 {print $6}' |awk 'NR==1 {print $0}'  `
else 
set main_result = `cat $taup_time_file |grep -w $main_PHASE | awk '$8>180 {print $6}' |awk 'NR==1 {print $0}'  `
endif
#echo "main $main_result tresult $tresult"
if($main_result == "" ) then
	set time_diff = 0
	else
	set time_diff = $main_result
endif


echo $time_diff
##//echo "main phase is $main_PHASE PHASE is $PHASE"

/bin/rm $taup_time_file
exit 0
