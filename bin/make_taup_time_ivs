#!/bin/tcsh
# This script makes big taup_file for each EQ-STA including all possible phases
# INPUT:
# 	EQ
# 	STA
# 	eventStation
# OUTPUT:
# 	big_taup time file named after taup_time.${EQ}.${STA} under current
# 	directory





set file_directory = .
set PHASE = $1
set eq_lat = $2
set eq_lon = $3
set eq_dep = $4
set sta_lat = $5
set sta_lon = $6
set ivs = $7

set name_convert = ~/bin/phase_name_convert_complex_to_simple.py
set PHASE = `python2 $name_convert $PHASE`

set taup_time_file = $file_directory/taup_time.${ivs}
set common_S_list = S,ScS,SS,SSS,Sdiff,ScSScS
set multi_S_phase = SSSS,SSSSS,SSSSSS
set multi_ScS_phase = ScSScSScS,ScSScSScSScS,ScSScSScSScSScS

set s_common_S_list = sS,sScS,sSS,sSSS,sSdiff,sScSScS
set s_multi_S_phase = sSSSS,sSSSSS,sSSSSSS
set s_multi_ScS_phase = sScSScSScS,sScSScSScSScS,sScSScSScSScSScS
set SKS_group = SKS,SKKS,sSKS,sSKKS

set P_list = P,PcP,Pdiff
set pP_list = pP,pPcP,pPdiff

set traffic_list = ${common_S_list},${s_common_S_list},${multi_S_phase},${s_multi_S_phase},${multi_ScS_phase},${s_multi_ScS_phase},${P_list},${pP_list},${SKS_group}



# remove major flag
if(`echo $PHASE | grep m ` == "" ) then
set main_PHASE = $PHASE

# compute PHASE travel time
set PHASE_PREM = `taup_time -mod prem -h $eq_dep -ph ${main_PHASE} -sta $sta_lat $sta_lon -evt $eq_lat $eq_lon |awk 'NR>5 && $8<180 {print $4}'|awk 'NR==1 {print $1}'`

taup_time -mod prem -ph $traffic_list -h $eq_dep -sta $sta_lat $sta_lon -evt $eq_lat $eq_lon |awk -v dd=${PHASE_PREM} 'NR>5{$4=$4-dd; print $0}'>! $taup_time_file

else
set main_PHASE = `echo $PHASE | sed 's/.$//' `

set PHASE_PREM = `taup_time -mod prem -h $eq_dep -ph ${main_PHASE} -sta $sta_lat $sta_lon -evt $eq_lat $eq_lon |awk 'NR>5 && $8>180 {print $4}'|awk 'NR==1 {print $1}'`

taup_time -mod prem -ph $traffic_list -h $eq_dep -sta $sta_lat $sta_lon -evt $eq_lat $eq_lon |awk -v dd=${PHASE_PREM} 'NR>5 {$4=$4-dd; print $0}'>! $taup_time_file

endif




## if taup_file for current main_PHASE does not exist, create it
#taup_time -mod prem -ph $traffic_list -h $eq_dep -sta $sta_lat $sta_lon -evt $eq_lat $eq_lon -rel $main_PHASE >! $taup_time_file
